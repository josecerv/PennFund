---
title: "Penn Med Field Experiment (N=402,931)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document: 
    toc: yes
    toc_depth: 3
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
   \usepackage{fvextra}
   \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(lmtest)
library(sandwich)
library(parameters)
library(pander)
library(stargazer)
library(car)
```

```{r include=FALSE}
if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}
robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}

```

\newpage

```{r include=FALSE}
# Load the Excel file
excel_file <- "PennFund.xlsx"
eml_master <- read_excel(
  path = excel_file,
  sheet = "EML Master Honor Roll Dec2024",
  col_types = "guess"
)

click_data <- read_excel(
  path = excel_file,
  sheet = "Click Data",
  col_types = "guess"
)

click_raw <- read_excel(
  path = excel_file,
  sheet = "Click Data",
  col_types = "guess"
)


# Convert date columns to datetime
eml_master <- eml_master %>%
  mutate(
    `Gift Date` = as_datetime(`Gift Date`),
    `HR Open Date and Time` = as_datetime(`HR Open Date and Time`),
    DOB = as_datetime(DOB),
    `HR Email Opened` = case_when(
      `HR Email Opened` == 1 ~ 1,
      TRUE ~ 0)
  )

click_data <- click_data %>%
  mutate(
    `Click Date` = as_datetime(`Click Date`)
  )

# Rename columns to more usable variable names
eml_master <- eml_master %>%
  rename(
    id = ID,
    in_crm = `In CRM`,
    made_gift = `Made Gift`,
    gift_amount = `Gift Amount`,
    gift_date = `Gift Date`,
    email_opened = `HR Email Opened`,
    email_open_date = `HR Open Date and Time`,
    engagement_score = `Engagement Score`,
    condition = `Honor Roll Group`,
    date_added = `Date Added`,
    gender = Gender,
    marital_status = MaritalStatus,
    dob = DOB,
    age = Age
  )


click_data <- click_data %>%
  rename(
    id = ID,
    associated_email = `Associated Email`,
    job_id = JobID,
    click_date = `Click Date`,
    link_name = LinkName,
    link_content = LinkContent,
    is_unique = IsUnique
  )

# Create age variable based on DOB
eml_master <- eml_master %>%
  mutate(
    age = year(ymd(format(Sys.Date(), "%Y-%m-%d"))) - year(dob),
    man = ifelse(gender == "Male", 1, 0)
  )

# Convert conditions to factors
eml_master$condition <- factor(eml_master$condition, levels = c("Control", "Explicit", "Excuse"))

# Filter click data to clicks related to our email campaigns
click_data <- click_data %>%
  filter(grepl("Honor Roll Touch", associated_email))
```

```{r include=FALSE}
# Identify unique clickers, taking only the first click date
click_data_campaign <- click_data %>%
  filter(grepl("Honor Roll Touch", link_name)) %>%
  group_by(id) %>%
  arrange(click_date) %>%
  slice(1) %>%
  ungroup() %>%
  select(id, click_date, associated_email) %>%
  rename(first_click_date = click_date)

# Merge the click data with the master data
master_data <- left_join(eml_master, click_data_campaign, by = "id")

# Create click-through indicator
master_data <- master_data %>%
  mutate(
    clicked_email_1 = ifelse(!is.na(first_click_date) &
                             grepl("Honor Roll Touch 1", associated_email) &
                             email_opened == 1 &
                             first_click_date <= ymd_hms("2024-12-19 00:00:00"), 1, 0),
        clicked_email_all = ifelse(!is.na(first_click_date) &
                                   email_opened == 1 &
                                    first_click_date <= ymd_hms("2025-01-01 00:00:00"), 1, 0)

  )

# Define email send dates
email1_send_date <- ymd_hms("2024-12-12 00:00:00")
email2_send_date <- ymd_hms("2024-12-19 00:00:00")
email3_send_date <- ymd_hms("2024-12-27 00:00:00")
campaign_end_date <- ymd_hms("2024-12-31 23:59:59") # December 31, 11:59 PM ET

# Modify master_data to include opened_email_1 and opened_email_all variables
master_data <- master_data %>%
  mutate(
    # Determine if Email #1 was opened between Email #1 send and Email #2 send
    opened_email_1 = ifelse(
      !is.na(email_open_date) &
        email_open_date >= email1_send_date &
        email_open_date < email2_send_date,
      1, 0
    ),
    # Use email_opened for opens across all emails (assuming it was updated accordingly)
    opened_email_all = ifelse(
      email_opened == 1 &
        email_open_date <= campaign_end_date, 1, 0
    )
  )


```


## Open Rates
### Summary Table

```{r echo=FALSE, results="asis"}
# Define email dates
email1_send_date <- ymd_hms("2024-12-12 00:00:00")
email2_send_date <- ymd_hms("2024-12-19 00:00:00")
email3_send_date <- ymd_hms("2024-12-27 00:00:00")
campaign_end_date <- ymd_hms("2024-12-31 23:59:59")

# Calculate total N
total_N <- nrow(master_data)

# Adjust condition labels and create email open indicators
master_data <- master_data %>%
  mutate(
    Condition = case_when(
      condition == "Excuse" ~ "Prosocial Excuse",
      TRUE ~ as.character(condition)
    ),
    # Define who opened each email
    opened_email_1 = case_when(
      !is.na(email_open_date) & 
        email_open_date >= email1_send_date & 
        email_open_date < email2_send_date ~ 1,
      TRUE ~ 0
    ),
    opened_email_2 = case_when(
      !is.na(email_open_date) & 
        email_open_date >= email2_send_date & 
        email_open_date < email3_send_date ~ 1,
      TRUE ~ 0
    ),
    opened_email_3 = case_when(
      !is.na(email_open_date) & 
        email_open_date >= email3_send_date & 
        email_open_date <= campaign_end_date ~ 1,
      TRUE ~ 0
    )
  )


# Calculate opens for Email 1 by condition and total
email1_data <- master_data %>%
  group_by(Condition) %>%
  summarize(
    n_total = n(),  # total in condition
    opens = sum(opened_email_1, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    email = "Email 1",
    percentage = (opens / n_total) * 100,  # within-condition percentage
    `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)")
  )

# Calculate opens for Email 2 by condition and total
email2_data <- master_data %>%
  group_by(Condition) %>%
  summarize(
    n_total = n(),  # total in condition
    opens = sum(opened_email_2, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    email = "Email 2",
    percentage = (opens / n_total) * 100,  # within-condition percentage
    `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)")
  )

# Calculate opens for Email 3 by condition and total
email3_data <- master_data %>%
  group_by(Condition) %>%
  summarize(
    n_total = n(),  # total in condition
    opens = sum(opened_email_3, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    email = "Email 3",
    percentage = (opens / n_total) * 100,  # within-condition percentage
    `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)")
  )

# Combine the data for the three emails
email_open_df <- bind_rows(email1_data, email2_data, email3_data)

# Calculate totals by condition across all emails
total_row <- master_data %>%
  group_by(Condition) %>%
  summarize(
    n_total = n(),
    opens = sum(opened_email_1, na.rm = TRUE) + 
            sum(opened_email_2, na.rm = TRUE) + 
            sum(opened_email_3, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    email = "Total",
    percentage = (opens / n_total) * 100,
    `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)")
  )

# Calculate column totals for each email and overall
column_totals <- bind_rows(
  # Email 1 total
  master_data %>%
    summarize(
      n_total = n(),
      opens = sum(opened_email_1, na.rm = TRUE),
      percentage = (opens / n_total) * 100,
      `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)"),
      email = "Email 1",
      Condition = "Total"
    ),
  # Email 2 total
  master_data %>%
    summarize(
      n_total = n(),
      opens = sum(opened_email_2, na.rm = TRUE),
      percentage = (opens / n_total) * 100,
      `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)"),
      email = "Email 2",
      Condition = "Total"
    ),
  # Email 3 total
  master_data %>%
    summarize(
      n_total = n(),
      opens = sum(opened_email_3, na.rm = TRUE),
      percentage = (opens / n_total) * 100,
      `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)"),
      email = "Email 3",
      Condition = "Total"
    ),
  # Overall total
  master_data %>%
    summarize(
      n_total = n(),
      opens = sum(opened_email_1, na.rm = TRUE) + 
              sum(opened_email_2, na.rm = TRUE) + 
              sum(opened_email_3, na.rm = TRUE),
      percentage = (opens / n_total) * 100,
      `Count (Percentage of N)` = paste0(opens, " (", round(percentage, 2), "%)"),
      email = "Total",
      Condition = "Total"
    )
)

# Combine all data
email_open_df <- bind_rows(
  email_open_df,
  total_row
) %>%
  select(email, Condition, `Count (Percentage of N)`)

# Create the final table
email_open_table <- email_open_df %>%
  pivot_wider(
    names_from = Condition,
    values_from = `Count (Percentage of N)`
  ) %>%
  left_join(
    column_totals %>% select(email, `Count (Percentage of N)`) %>%
      rename(Total = `Count (Percentage of N)`),
    by = "email"
  ) %>%
  select(email, Control, `Prosocial Excuse`, Explicit, Total) # Reorder columns

# Ensure the order of emails
email_order <- c("Email 1", "Email 2", "Email 3", "Total")
email_open_table$email <- factor(email_open_table$email, levels = email_order)
email_open_table <- email_open_table %>%
  arrange(email)

# Display the table using pander
pander(email_open_table,
       caption = "Counts and Percentages of Email Opens by Condition (Within-Condition Percentages)",
       style = "rmarkdown",
       split.table = Inf)


```



### Open Rates for Email 1 and Combined Emails

```{r echo=FALSE, results="asis"}

master_data <- master_data %>%
  mutate(
    Condition = factor(Condition, levels = c("Control", "Prosocial Excuse", "Explicit"))
  )


model_email1_open <- lm(opened_email_1 ~ Condition, data = master_data)

# Calculate robust standard errors
robust_se_email1_open <- coeftest(model_email1_open, vcov = vcovHC(model_email1_open, type = "HC3"))[, "Std. Error"]

# Regression model for all emails
model_email_all_open <- lm(opened_email_all ~ Condition, data = master_data)

# Calculate robust standard errors
robust_se_email_all_open <- coeftest(model_email_all_open, vcov = vcovHC(model_email_all_open, type = "HC3"))[, "Std. Error"]

# Use stargazer to output the model summary
stargazer(model_email1_open, model_email_all_open,
          type = "latex",
          header = F,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_email1_open, robust_se_email_all_open),
          title = "OLS Model Results for Email 1 Open Rates",
          covariate.labels = c("Prosocial Excuse", "Explicit"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Open (Email 1 Period)", "Open (Full Campaign)"),
          notes = "+p<0.1; *p<0.05; **p<0.01; ***p<0.001",
          notes.append = F
          )

```

- Open rates are significantly different across conditions for Email 1 and combined emails. So we will analyze all participants, as pre-registered.


\newpage

## Click Rates (DV1)
### Summary

```{r echo=FALSE, results="asis"}
# Get condition totals first
condition_totals <- master_data %>%
  group_by(condition) %>%
  summarize(n = n())

# Filter for only the Honor Roll Touches to start
email_data_table <- master_data %>%
    filter(grepl("Honor Roll Touch", associated_email))

# Extract the email number from the 'associated_email' column
email_data_table <- email_data_table %>%
  mutate(
    email_number = case_when(
      grepl("Honor Roll Touch 1", associated_email) ~ "Email 1",
      grepl("Honor Roll Touch 2", associated_email) ~ "Email 2",
      grepl("Honor Roll Touch 3", associated_email) ~ "Email 3",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(email_number))

# Get the cross-tabulation by email number and condition
email_touch_counts <- table(email_data_table$email_number, email_data_table$condition)

# Calculate percentages based on condition totals
email_touch_percentages <- sweep(email_touch_counts, MARGIN = 2, 
                               STATS = condition_totals$n, 
                               FUN = "/") * 100

# Convert to data frames
email_touch_df <- as.data.frame.matrix(email_touch_counts)
email_touch_percentage_df <- as.data.frame.matrix(round(email_touch_percentages, 2))

# Add row names as a column
email_touch_df <- email_touch_df %>%
  rownames_to_column(var = "Email")

email_touch_percentage_df <- email_touch_percentage_df %>%
  rownames_to_column(var = "Email")

# Combine counts and percentages
email_touch_df <- email_touch_df %>%
  left_join(email_touch_percentage_df, by = "Email", 
            suffix = c(".count", ".pct")) %>%
  mutate(
    Control_n = Control.count,
    Excuse_n = Excuse.count,
    Explicit_n = Explicit.count,
    Total_n = rowSums(select(., Control.count, Excuse.count, Explicit.count)),
    Control = paste0(Control.count, " (", Control.pct, "%)"),
    `Prosocial Excuse` = paste0(Excuse.count, " (", Excuse.pct, "%)"),
    Explicit = paste0(Explicit.count, " (", Explicit.pct, "%)"),
    # For total column, use total N as denominator
    Total = paste0(Total_n, " (", round(Total_n/total_N*100, 2), "%)")
  )

# Create total row with within-condition percentages
total_row <- tibble(
  "Email" = "Total",
  Control = paste0(
    sum(email_touch_df$Control_n), 
    " (", 
    round(sum(email_touch_df$Control_n)/condition_totals$n[condition_totals$condition == "Control"]*100, 2), 
    "%)"
  ),
  "Prosocial Excuse" = paste0(
    sum(email_touch_df$Excuse_n), 
    " (", 
    round(sum(email_touch_df$Excuse_n)/condition_totals$n[condition_totals$condition == "Excuse"]*100, 2), 
    "%)"
  ),
  Explicit = paste0(
    sum(email_touch_df$Explicit_n), 
    " (", 
    round(sum(email_touch_df$Explicit_n)/condition_totals$n[condition_totals$condition == "Explicit"]*100, 2), 
    "%)"
  ),
  Total = paste0(
    sum(email_touch_df$Total_n), 
    " (", 
    round(sum(email_touch_df$Total_n)/total_N*100, 2), 
    "%)"
  )
)

# Create the final table
email_touch_df <- email_touch_df %>%
  select("Email", Control, "Prosocial Excuse", Explicit, Total) %>%
  bind_rows(total_row)

# Display the table using pander
pander(email_touch_df,
       caption = "Counts and Percentages of Email Clicks by Condition (Within-Condition Percentages)",
       split.table = Inf,
       style = 'rmarkdown',
       justify = c('left', 'right', 'right', 'right', 'right'))


```


### Primary Analyses (DV1): Click-Through Rates (Email 1 + Combined Emails)

```{r echo=FALSE, results="asis"}
# Create binary gender indicator, age numeric, and condition_model in master_data
master_data <- master_data %>%
  mutate(
    man = ifelse(gender == "Male", 1, 0),
    age = as.numeric(age),
    condition = as.factor(condition)
  )

# Replace 'Excuse' with 'Prosocial Excuse' in 'condition' variable
levels(master_data$condition)[levels(master_data$condition) == 'Excuse'] <- 'Prosocial Excuse'

# Create condition_model without spaces
master_data$condition_model <- factor(master_data$condition)
levels(master_data$condition_model) <- c('Control', 'Explicit', 'ProsocialExcuse')

# Ensure 'Control' is the reference level
master_data$condition_model <- relevel(master_data$condition_model, ref = 'Control')

# Create email1_data and email_all_data with all necessary variables
email1_data <- master_data %>%
  select(id, condition, condition_model, clicked_email_1, gender, age, man)

email_all_data <- master_data %>%
  select(id, condition, condition_model, clicked_email_all, gender, age, man)

# Models for Email 1 Period
model_email1 <- lm(clicked_email_1 ~ condition_model, data = email1_data)
model_email1_controls <- lm(clicked_email_1 ~ condition_model + man + age, data = email1_data)

# Models for Full Campaign
model_email_all <- lm(clicked_email_all ~ condition_model, data = email_all_data)
model_email_all_controls <- lm(clicked_email_all ~ condition_model + man + age, data = email_all_data)

# Calculate robust standard errors for all models
robust_se_email1 <- coeftest(model_email1, vcov = vcovHC(model_email1, type = "HC3"))[, "Std. Error"]
robust_se_email1_controls <- coeftest(model_email1_controls, vcov = vcovHC(model_email1_controls, type = "HC3"))[, "Std. Error"]
robust_se_email_all <- coeftest(model_email_all, vcov = vcovHC(model_email_all, type = "HC3"))[, "Std. Error"]
robust_se_email_all_controls <- coeftest(model_email_all_controls, vcov = vcovHC(model_email_all_controls, type = "HC3"))[, "Std. Error"]

# Wald tests for all models
wald_test1 <- linearHypothesis(model_email1,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_email1, type = "HC3"))
wald_test1_controls <- linearHypothesis(model_email1_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_email1_controls, type = "HC3"))
wald_test2 <- linearHypothesis(model_email_all,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_email_all, type = "HC3"))
wald_test2_controls <- linearHypothesis(model_email_all_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_email_all_controls, type = "HC3"))

# Add the Controls? line for the stargazer table
controls_line <- list(
  c("Controls?", "No", "Yes", "No", "Yes")
)

# Use stargazer to output all model summaries
stargazer(model_email1, model_email1_controls, 
          model_email_all, model_email_all_controls,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_email1, robust_se_email1_controls,
                   robust_se_email_all, robust_se_email_all_controls),
          title = "OLS Model Results for Click-Through Rates",
          covariate.labels = c("Explicit", "Prosocial Excuse", "Man", "Age"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Clicked (Email 1 Period)", "Clicked (Full Campaign)"),
          star.char = c("***", "**", "*", "+"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE,
          add.lines = controls_line
          )

# Print Wald test results separately below the table
cat("\nWald Tests for Email 1 Period:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1$Df[2], wald_test1$Res.Df[2], 
            wald_test1$F[2], wald_test1$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1_controls$Df[2], wald_test1_controls$Res.Df[2], 
            wald_test1_controls$F[2], wald_test1_controls$`Pr(>F)`[2]))

cat("\nWald Tests for Full Campaign:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2$Df[2], wald_test2$Res.Df[2], 
            wald_test2$F[2], wald_test2$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2_controls$Df[2], wald_test2_controls$Res.Df[2], 
            wald_test2_controls$F[2], wald_test2_controls$`Pr(>F)`[2]))

```

\newpage

## Donation Incidence (DV2)
### Summary

```{r echo=FALSE, results="asis"}
options(scipen=999)
# Get total N and condition Ns
total_N <- nrow(master_data)
condition_totals <- master_data %>%
  group_by(condition) %>%
  summarize(n = n())

# Define email periods
email1_start <- ymd_hms("2024-12-12 00:00:00")
email2_start <- ymd_hms("2024-12-19 00:00:00")
email3_start <- ymd_hms("2024-12-27 00:00:00")
campaign_end <- ymd_hms("2024-12-31 23:59:59")

# Calculate donations by condition and email period
donation_summary <- master_data %>%
  mutate(
    donated_email_1 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date < email2_start, 
      1, 0
    ),
    donated_email_2 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email2_start & 
        gift_date < email3_start,
      1, 0
    ),
    donated_email_3 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email3_start & 
        gift_date <= campaign_end,
      1, 0
    ),
    donated_any = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date <= campaign_end,
      1, 0
    )
  ) %>%
  group_by(condition) %>%
  summarize(
    n_condition = n(),
    donations_email1 = sum(donated_email_1, na.rm = TRUE),
    donations_email2 = sum(donated_email_2, na.rm = TRUE),
    donations_email3 = sum(donated_email_3, na.rm = TRUE),
    donations_total = sum(donated_any, na.rm = TRUE),
    .groups = 'drop'
  )

# Calculate totals
total_donations <- donation_summary %>%
  summarize(
    n_condition = sum(n_condition),
    donations_email1 = sum(donations_email1),
    donations_email2 = sum(donations_email2),
    donations_email3 = sum(donations_email3),
    donations_total = sum(donations_total)
  )

# Create summary table
donation_table <- data.frame(
  "Email Period" = c("Email 1 Period", "Email 2 Period", "Email 3 Period", "Total Campaign"),
  
  "Control" = c(
    paste0(donation_summary$donations_email1[donation_summary$condition == "Control"],
           " (", round(donation_summary$donations_email1[donation_summary$condition == "Control"]/
                        donation_summary$n_condition[donation_summary$condition == "Control"]*100, 5), "%)"),
    paste0(donation_summary$donations_email2[donation_summary$condition == "Control"],
           " (", round(donation_summary$donations_email2[donation_summary$condition == "Control"]/
                        donation_summary$n_condition[donation_summary$condition == "Control"]*100, 5), "%)"),
    paste0(donation_summary$donations_email3[donation_summary$condition == "Control"],
           " (", round(donation_summary$donations_email3[donation_summary$condition == "Control"]/
                        donation_summary$n_condition[donation_summary$condition == "Control"]*100, 5), "%)"),
    paste0(donation_summary$donations_total[donation_summary$condition == "Control"],
           " (", round(donation_summary$donations_total[donation_summary$condition == "Control"]/
                        donation_summary$n_condition[donation_summary$condition == "Control"]*100, 5), "%)")
  ),
  
  "Prosocial Excuse" = c(
    paste0(donation_summary$donations_email1[donation_summary$condition == "Prosocial Excuse"],
           " (", round(donation_summary$donations_email1[donation_summary$condition == "Prosocial Excuse"]/
                        donation_summary$n_condition[donation_summary$condition == "Prosocial Excuse"]*100, 5), "%)"),
    paste0(donation_summary$donations_email2[donation_summary$condition == "Prosocial Excuse"],
           " (", round(donation_summary$donations_email2[donation_summary$condition == "Prosocial Excuse"]/
                        donation_summary$n_condition[donation_summary$condition == "Prosocial Excuse"]*100, 5), "%)"),
    paste0(donation_summary$donations_email3[donation_summary$condition == "Prosocial Excuse"],
           " (", round(donation_summary$donations_email3[donation_summary$condition == "Prosocial Excuse"]/
                        donation_summary$n_condition[donation_summary$condition == "Prosocial Excuse"]*100, 5), "%)"),
    paste0(donation_summary$donations_total[donation_summary$condition == "Prosocial Excuse"],
           " (", round(donation_summary$donations_total[donation_summary$condition == "Prosocial Excuse"]/
                        donation_summary$n_condition[donation_summary$condition == "Prosocial Excuse"]*100, 5), "%)")
  ),
  
  "Explicit" = c(
    paste0(donation_summary$donations_email1[donation_summary$condition == "Explicit"],
           " (", round(donation_summary$donations_email1[donation_summary$condition == "Explicit"]/
                        donation_summary$n_condition[donation_summary$condition == "Explicit"]*100, 5), "%)"),
    paste0(donation_summary$donations_email2[donation_summary$condition == "Explicit"],
           " (", round(donation_summary$donations_email2[donation_summary$condition == "Explicit"]/
                        donation_summary$n_condition[donation_summary$condition == "Explicit"]*100, 5), "%)"),
    paste0(donation_summary$donations_email3[donation_summary$condition == "Explicit"],
           " (", round(donation_summary$donations_email3[donation_summary$condition == "Explicit"]/
                        donation_summary$n_condition[donation_summary$condition == "Explicit"]*100, 5), "%)"),
    paste0(donation_summary$donations_total[donation_summary$condition == "Explicit"],
           " (", round(donation_summary$donations_total[donation_summary$condition == "Explicit"]/
                        donation_summary$n_condition[donation_summary$condition == "Explicit"]*100, 5), "%)")
  ),
  
  "Total" = c(
    paste0(total_donations$donations_email1,
           " (", round(total_donations$donations_email1/total_donations$n_condition*100, 5), "%)"),
    paste0(total_donations$donations_email2,
           " (", round(total_donations$donations_email2/total_donations$n_condition*100, 5), "%)"),
    paste0(total_donations$donations_email3,
           " (", round(total_donations$donations_email3/total_donations$n_condition*100, 5), "%)"),
    paste0(total_donations$donations_total,
           " (", round(total_donations$donations_total/total_donations$n_condition*100, 5), "%)")
  )
)

# Display the table using pander
pander(donation_table,
       caption = "Counts and Percentages of Donations by Condition and Email Period (Within-Condition Percentages)",
       split.table = Inf)

```

### Primary Analyses (DV2): Donation Incidence (Email 1 + Combined Emails)

```{r echo=FALSE, results="asis"}
# Create donation indicator variables
master_data <- master_data %>%
  mutate(
    donated_email_1 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date < email2_start, 
      1, 0
    ),
    donated_any = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date <= campaign_end,
      1, 0
    )
  )

# Models for Email 1 Period
model_donation1 <- lm(donated_email_1 ~ condition_model, data = master_data)
model_donation1_controls <- lm(donated_email_1 ~ condition_model + man + age, data = master_data)

# Models for Full Campaign
model_donation_all <- lm(donated_any ~ condition_model, data = master_data)
model_donation_all_controls <- lm(donated_any ~ condition_model + man + age, data = master_data)

# Calculate robust standard errors for all models
robust_se_donation1 <- coeftest(model_donation1, vcov = vcovHC(model_donation1, type = "HC3"))[, "Std. Error"]
robust_se_donation1_controls <- coeftest(model_donation1_controls, vcov = vcovHC(model_donation1_controls, type = "HC3"))[, "Std. Error"]
robust_se_donation_all <- coeftest(model_donation_all, vcov = vcovHC(model_donation_all, type = "HC3"))[, "Std. Error"]
robust_se_donation_all_controls <- coeftest(model_donation_all_controls, vcov = vcovHC(model_donation_all_controls, type = "HC3"))[, "Std. Error"]

# Wald tests for all models
wald_test1 <- linearHypothesis(model_donation1,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_donation1, type = "HC3"))
wald_test1_controls <- linearHypothesis(model_donation1_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_donation1_controls, type = "HC3"))
wald_test2 <- linearHypothesis(model_donation_all,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_donation_all, type = "HC3"))
wald_test2_controls <- linearHypothesis(model_donation_all_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_donation_all_controls, type = "HC3"))

# Add the Controls? line for the stargazer table
controls_line <- list(
  c("Controls?", "No", "Yes", "No", "Yes")
)

# Use stargazer to output all model summaries
stargazer(model_donation1, model_donation1_controls, 
          model_donation_all, model_donation_all_controls,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_donation1, robust_se_donation1_controls,
                   robust_se_donation_all, robust_se_donation_all_controls),
          title = "OLS Model Results for Donation Incidence",
          covariate.labels = c("Explicit", "Prosocial Excuse", "Man", "Age"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Donated (Email 1 Period)", "Donated (Full Campaign)"),
          star.char = c("***", "**", "*", "+"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE,
          add.lines = controls_line
          )

# Print Wald test results separately below the table
cat("\nWald Tests for Email 1 Period:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1$Df[2], wald_test1$Res.Df[2], 
            wald_test1$F[2], wald_test1$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1_controls$Df[2], wald_test1_controls$Res.Df[2], 
            wald_test1_controls$F[2], wald_test1_controls$`Pr(>F)`[2]))

cat("\nWald Tests for Full Campaign:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2$Df[2], wald_test2$Res.Df[2], 
            wald_test2$F[2], wald_test2$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2_controls$Df[2], wald_test2_controls$Res.Df[2], 
            wald_test2_controls$F[2], wald_test2_controls$`Pr(>F)`[2]))

```

\newpage

## Donation Amount (DV3)
### Summary

```{r echo=FALSE, results="asis"}
# Get total N from master_data
total_N <- nrow(master_data)

# Calculate median and MAD for non-zero donations
non_zero_donations <- master_data %>%
  filter(gift_amount > 0)
median_amount <- median(non_zero_donations$gift_amount, na.rm = TRUE)
mad_amount <- mad(non_zero_donations$gift_amount, na.rm = TRUE)
outlier_cutoff <- median_amount + (2.5 * mad_amount)

# Calculate donation amounts by condition and email period
donation_amount_summary <- master_data %>%
  mutate(
    # Amount during Email 1 period
    amount_email_1 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date < email2_start, 
      gift_amount, 0
    ),
    # Total amount during campaign
    amount_any = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date <= campaign_end,
      gift_amount, 0
    )
  ) %>%
  group_by(condition) %>%
  summarize(
    amount_email1 = sum(amount_email_1, na.rm = TRUE),
    amount_total = sum(amount_any, na.rm = TRUE),
    n_donors_email1 = sum(amount_email_1 > 0, na.rm = TRUE),
    n_donors_total = sum(amount_any > 0, na.rm = TRUE),
    .groups = 'drop'
  )

# Create summary table
amount_table <- data.frame(
  "Email Period" = c("Email 1 Period", "Full Campaign"),
  
  "Control" = c(
    paste0("$", format(donation_amount_summary$amount_email1[donation_amount_summary$condition == "Control"], big.mark=","),
           " (n=", donation_amount_summary$n_donors_email1[donation_amount_summary$condition == "Control"], ")"),
    paste0("$", format(donation_amount_summary$amount_total[donation_amount_summary$condition == "Control"], big.mark=","),
           " (n=", donation_amount_summary$n_donors_total[donation_amount_summary$condition == "Control"], ")")
  ),
  
  "Prosocial Excuse" = c(
    paste0("$", format(donation_amount_summary$amount_email1[donation_amount_summary$condition == "Prosocial Excuse"], big.mark=","),
           " (n=", donation_amount_summary$n_donors_email1[donation_amount_summary$condition == "Prosocial Excuse"], ")"),
    paste0("$", format(donation_amount_summary$amount_total[donation_amount_summary$condition == "Prosocial Excuse"], big.mark=","),
           " (n=", donation_amount_summary$n_donors_total[donation_amount_summary$condition == "Prosocial Excuse"], ")")
  ),
  
  "Explicit" = c(
    paste0("$", format(donation_amount_summary$amount_email1[donation_amount_summary$condition == "Explicit"], big.mark=","),
           " (n=", donation_amount_summary$n_donors_email1[donation_amount_summary$condition == "Explicit"], ")"),
    paste0("$", format(donation_amount_summary$amount_total[donation_amount_summary$condition == "Explicit"], big.mark=","),
           " (n=", donation_amount_summary$n_donors_total[donation_amount_summary$condition == "Explicit"], ")")
  )
)

# Display the table using pander
pander(amount_table,
       caption = "Total Donation Amounts by Condition and Email Period (Number of Donors)")
```

### Primary Analyses (DV3): Donation Amount (Raw) (Email 1 + Combined Emails)

```{r echo=FALSE, results="asis"}
# Calculate median and MAD for non-zero donations
non_zero_donations <- master_data %>%
  filter(gift_amount > 0)
median_amount <- median(non_zero_donations$gift_amount, na.rm = TRUE)
mad_amount <- mad(non_zero_donations$gift_amount, na.rm = TRUE)
outlier_cutoff <- median_amount + (2.5 * mad_amount)

# Update master_data with donation amount variables
master_data <- master_data %>%
  mutate(
    # Raw amounts
    amount_email_1 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date < email2_start, 
      gift_amount, 0
    ),
    amount_any = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date <= campaign_end,
      gift_amount, 0
    )
  )

# Models for Email 1 Period
model_amount1 <- lm(amount_email_1 ~ condition_model, data = master_data)
model_amount1_controls <- lm(amount_email_1 ~ condition_model + man + age, data = master_data)

# Models for Full Campaign
model_amount_all <- lm(amount_any ~ condition_model, data = master_data)
model_amount_all_controls <- lm(amount_any ~ condition_model + man + age, data = master_data)

# Calculate robust standard errors for all models
robust_se_amount1 <- coeftest(model_amount1, vcov = vcovHC(model_amount1, type = "HC3"))[, "Std. Error"]
robust_se_amount1_controls <- coeftest(model_amount1_controls, vcov = vcovHC(model_amount1_controls, type = "HC3"))[, "Std. Error"]
robust_se_amount_all <- coeftest(model_amount_all, vcov = vcovHC(model_amount_all, type = "HC3"))[, "Std. Error"]
robust_se_amount_all_controls <- coeftest(model_amount_all_controls, vcov = vcovHC(model_amount_all_controls, type = "HC3"))[, "Std. Error"]

# Wald tests for all models
wald_test1 <- linearHypothesis(model_amount1,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_amount1, type = "HC3"))
wald_test1_controls <- linearHypothesis(model_amount1_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_amount1_controls, type = "HC3"))
wald_test2 <- linearHypothesis(model_amount_all,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_amount_all, type = "HC3"))
wald_test2_controls <- linearHypothesis(model_amount_all_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_amount_all_controls, type = "HC3"))

# Add the Controls? line for the stargazer table
controls_line <- list(
  c("Controls?", "No", "Yes", "No", "Yes")
)

# Use stargazer to output all model summaries
stargazer(model_amount1, model_amount1_controls, 
          model_amount_all, model_amount_all_controls,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_amount1, robust_se_amount1_controls,
                   robust_se_amount_all, robust_se_amount_all_controls),
          title = "OLS Model Results for Donation Amount (Raw)",
          covariate.labels = c("Explicit", "Prosocial Excuse", "Man", "Age"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Amount (Email 1 Period)", "Amount (Full Campaign)"),
          star.char = c("***", "**", "*", "+"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE,
          add.lines = controls_line
          )

# Print Wald test results separately below the table
cat("\nWald Tests for Email 1 Period:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1$Df[2], wald_test1$Res.Df[2], 
            wald_test1$F[2], wald_test1$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1_controls$Df[2], wald_test1_controls$Res.Df[2], 
            wald_test1_controls$F[2], wald_test1_controls$`Pr(>F)`[2]))

cat("\nWald Tests for Full Campaign:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2$Df[2], wald_test2$Res.Df[2], 
            wald_test2$F[2], wald_test2$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2_controls$Df[2], wald_test2_controls$Res.Df[2], 
            wald_test2_controls$F[2], wald_test2_controls$`Pr(>F)`[2]))
```

\newpage

### Primary Analyses (DV3): Donation Amount (Log-Transformed) (Email 1 + Combined Emails)

```{r echo=FALSE, results="asis"}
# Create amount variables and their log transformations
master_data <- master_data %>%
  mutate(
    # Raw amounts
    amount_email_1 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date < email2_start, 
      gift_amount, 0
    ),
    amount_any = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date <= campaign_end,
      gift_amount, 0
    ),
    # Log-transformed amounts (adding 1 to handle zeros)
    log_amount_email_1 = log(amount_email_1 + 1),
    log_amount_any = log(amount_any + 1)
  )

# Models for Email 1 Period (Log-Transformed)
model_log1 <- lm(log_amount_email_1 ~ condition_model, data = master_data)
model_log1_controls <- lm(log_amount_email_1 ~ condition_model + man + age, data = master_data)

# Models for Full Campaign (Log-Transformed)
model_log_all <- lm(log_amount_any ~ condition_model, data = master_data)
model_log_all_controls <- lm(log_amount_any ~ condition_model + man + age, data = master_data)

# Calculate robust standard errors for all models
robust_se_log1 <- coeftest(model_log1, vcov = vcovHC(model_log1, type = "HC3"))[, "Std. Error"]
robust_se_log1_controls <- coeftest(model_log1_controls, vcov = vcovHC(model_log1_controls, type = "HC3"))[, "Std. Error"]
robust_se_log_all <- coeftest(model_log_all, vcov = vcovHC(model_log_all, type = "HC3"))[, "Std. Error"]
robust_se_log_all_controls <- coeftest(model_log_all_controls, vcov = vcovHC(model_log_all_controls, type = "HC3"))[, "Std. Error"]

# Wald tests for all models
wald_test1 <- linearHypothesis(model_log1,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_log1, type = "HC3"))
wald_test1_controls <- linearHypothesis(model_log1_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_log1_controls, type = "HC3"))
wald_test2 <- linearHypothesis(model_log_all,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_log_all, type = "HC3"))
wald_test2_controls <- linearHypothesis(model_log_all_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_log_all_controls, type = "HC3"))

# Add the Controls? line for the stargazer table
controls_line <- list(
  c("Controls?", "No", "Yes", "No", "Yes")
)

# Use stargazer to output all model summaries
stargazer(model_log1, model_log1_controls, 
          model_log_all, model_log_all_controls,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_log1, robust_se_log1_controls,
                   robust_se_log_all, robust_se_log_all_controls),
          title = "OLS Model Results for Donation Amount (Log-Transformed)",
          covariate.labels = c("Explicit", "Prosocial Excuse", "Man", "Age"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Log Amount (Email 1 Period)", "Log Amount (Full Campaign)"),
          star.char = c("***", "**", "*", "+"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE,
          add.lines = controls_line
          )

# Print Wald test results separately below the table
cat("\nWald Tests for Email 1 Period:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1$Df[2], wald_test1$Res.Df[2], 
            wald_test1$F[2], wald_test1$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1_controls$Df[2], wald_test1_controls$Res.Df[2], 
            wald_test1_controls$F[2], wald_test1_controls$`Pr(>F)`[2]))

cat("\nWald Tests for Full Campaign:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2$Df[2], wald_test2$Res.Df[2], 
            wald_test2$F[2], wald_test2$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2_controls$Df[2], wald_test2_controls$Res.Df[2], 
            wald_test2_controls$F[2], wald_test2_controls$`Pr(>F)`[2]))
```

\newpage

### Primary Analyses (DV3): Donation Amount (Outliers Removed) (Email 1 + Combined Emails)

```{r echo=FALSE, results="asis"}
# Calculate median and MAD for non-zero donations
non_zero_donations <- master_data %>%
  filter(gift_amount > 0)
median_amount <- median(non_zero_donations$gift_amount, na.rm = TRUE)
mad_amount <- mad(non_zero_donations$gift_amount, na.rm = TRUE)
outlier_cutoff <- median_amount + (2.5 * mad_amount)

# Create amount variables and their no-outliers versions
master_data <- master_data %>%
  mutate(
    # Raw amounts
    amount_email_1 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date < email2_start, 
      gift_amount, 0
    ),
    amount_any = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date <= campaign_end,
      gift_amount, 0
    ),
    # Amounts with outliers removed
    amount_email_1_no_outliers = ifelse(
      amount_email_1 > outlier_cutoff, NA, amount_email_1
    ),
    amount_any_no_outliers = ifelse(
      amount_any > outlier_cutoff, NA, amount_any
    )
  )

# Models for Email 1 Period (No Outliers)
model_no_outliers1 <- lm(amount_email_1_no_outliers ~ condition_model, data = master_data)
model_no_outliers1_controls <- lm(amount_email_1_no_outliers ~ condition_model + man + age, data = master_data)

# Models for Full Campaign (No Outliers)
model_no_outliers_all <- lm(amount_any_no_outliers ~ condition_model, data = master_data)
model_no_outliers_all_controls <- lm(amount_any_no_outliers ~ condition_model + man + age, data = master_data)

# Calculate robust standard errors for all models
robust_se_no_outliers1 <- coeftest(model_no_outliers1, vcov = vcovHC(model_no_outliers1, type = "HC3"))[, "Std. Error"]
robust_se_no_outliers1_controls <- coeftest(model_no_outliers1_controls, vcov = vcovHC(model_no_outliers1_controls, type = "HC3"))[, "Std. Error"]
robust_se_no_outliers_all <- coeftest(model_no_outliers_all, vcov = vcovHC(model_no_outliers_all, type = "HC3"))[, "Std. Error"]
robust_se_no_outliers_all_controls <- coeftest(model_no_outliers_all_controls, vcov = vcovHC(model_no_outliers_all_controls, type = "HC3"))[, "Std. Error"]

# Wald tests for all models
wald_test1 <- linearHypothesis(model_no_outliers1,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_no_outliers1, type = "HC3"))
wald_test1_controls <- linearHypothesis(model_no_outliers1_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_no_outliers1_controls, type = "HC3"))
wald_test2 <- linearHypothesis(model_no_outliers_all,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_no_outliers_all, type = "HC3"))
wald_test2_controls <- linearHypothesis(model_no_outliers_all_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_no_outliers_all_controls, type = "HC3"))

# Add the Controls? line for the stargazer table
controls_line <- list(
  c("Controls?", "No", "Yes", "No", "Yes")
)

# Use stargazer to output all model summaries
stargazer(model_no_outliers1, model_no_outliers1_controls, 
          model_no_outliers_all, model_no_outliers_all_controls,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_no_outliers1, robust_se_no_outliers1_controls,
                   robust_se_no_outliers_all, robust_se_no_outliers_all_controls),
          title = "OLS Model Results for Donation Amount (Outliers Removed)",
          covariate.labels = c("Explicit", "Prosocial Excuse", "Man", "Age"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Amount (Email 1 Period)", "Amount (Full Campaign)"),
          star.char = c("***", "**", "*", "+"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE,
          add.lines = controls_line
          )

# Print Wald test results separately below the table
cat("\nWald Tests for Email 1 Period:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1$Df[2], wald_test1$Res.Df[2], 
            wald_test1$F[2], wald_test1$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1_controls$Df[2], wald_test1_controls$Res.Df[2], 
            wald_test1_controls$F[2], wald_test1_controls$`Pr(>F)`[2]))

cat("\nWald Tests for Full Campaign:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2$Df[2], wald_test2$Res.Df[2], 
            wald_test2$F[2], wald_test2$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2_controls$Df[2], wald_test2_controls$Res.Df[2], 
            wald_test2_controls$F[2], wald_test2_controls$`Pr(>F)`[2]))
```


\newpage

## Unsubscribe Rate (DV4)
### Summary

```{r echo=FALSE, results="asis"}
# Get total N and condition Ns
total_N <- nrow(master_data)
condition_totals <- master_data %>%
  group_by(condition) %>%
  summarize(n = n())

# Process click_data to identify unsubscribes
unsubscribe_clicks <- click_data %>%
  filter(link_name == "Unsubscribe") %>%
  mutate(
    email_period = case_when(
      click_date >= email1_start & click_date < email2_start ~ "email1",
      click_date >= email2_start & click_date < email3_start ~ "email2",
      click_date >= email3_start & click_date <= campaign_end ~ "email3",
      TRUE ~ NA_character_
    )
  ) %>%
  group_by(id) %>%
  summarize(
    unsub_email_1 = any(email_period == "email1"),
    unsub_any = TRUE,
    .groups = "drop"
  )

# Merge unsubscribe data with master_data
master_data <- master_data %>%
  left_join(unsubscribe_clicks, by = c("id" = "id")) %>%
  mutate(
    unsub_email_1 = replace_na(unsub_email_1, FALSE),
    unsub_any = replace_na(unsub_any, FALSE)
  )

# Calculate unsubscribes by condition
unsubscribe_summary <- master_data %>%
  group_by(condition) %>%
  summarize(
    n_condition = n(),
    unsubs_email1 = sum(unsub_email_1, na.rm = TRUE),
    unsubs_total = sum(unsub_any, na.rm = TRUE),
    .groups = 'drop'
  )

# Calculate totals
total_unsubs <- unsubscribe_summary %>%
  summarize(
    n_condition = sum(n_condition),
    unsubs_email1 = sum(unsubs_email1),
    unsubs_total = sum(unsubs_total)
  )

# Create summary table
unsubscribe_table <- data.frame(
  "Email Period" = c("Email 1 Period", "Full Campaign"),
  
  "Control" = c(
    paste0(unsubscribe_summary$unsubs_email1[unsubscribe_summary$condition == "Control"],
           " (", round(unsubscribe_summary$unsubs_email1[unsubscribe_summary$condition == "Control"]/
                        unsubscribe_summary$n_condition[unsubscribe_summary$condition == "Control"]*100, 5), "%)"),
    paste0(unsubscribe_summary$unsubs_total[unsubscribe_summary$condition == "Control"],
           " (", round(unsubscribe_summary$unsubs_total[unsubscribe_summary$condition == "Control"]/
                        unsubscribe_summary$n_condition[unsubscribe_summary$condition == "Control"]*100, 5), "%)")
  ),
  
  "Prosocial Excuse" = c(
    paste0(unsubscribe_summary$unsubs_email1[unsubscribe_summary$condition == "Prosocial Excuse"],
           " (", round(unsubscribe_summary$unsubs_email1[unsubscribe_summary$condition == "Prosocial Excuse"]/
                        unsubscribe_summary$n_condition[unsubscribe_summary$condition == "Prosocial Excuse"]*100, 5), "%)"),
    paste0(unsubscribe_summary$unsubs_total[unsubscribe_summary$condition == "Prosocial Excuse"],
           " (", round(unsubscribe_summary$unsubs_total[unsubscribe_summary$condition == "Prosocial Excuse"]/
                        unsubscribe_summary$n_condition[unsubscribe_summary$condition == "Prosocial Excuse"]*100, 5), "%)")
  ),
  
  "Explicit" = c(
    paste0(unsubscribe_summary$unsubs_email1[unsubscribe_summary$condition == "Explicit"],
           " (", round(unsubscribe_summary$unsubs_email1[unsubscribe_summary$condition == "Explicit"]/
                        unsubscribe_summary$n_condition[unsubscribe_summary$condition == "Explicit"]*100, 5), "%)"),
    paste0(unsubscribe_summary$unsubs_total[unsubscribe_summary$condition == "Explicit"],
           " (", round(unsubscribe_summary$unsubs_total[unsubscribe_summary$condition == "Explicit"]/
                        unsubscribe_summary$n_condition[unsubscribe_summary$condition == "Explicit"]*100, 5), "%)")
  ),
  
  "Total" = c(
    paste0(total_unsubs$unsubs_email1,
           " (", round(total_unsubs$unsubs_email1/total_unsubs$n_condition*100, 5), "%)"),
    paste0(total_unsubs$unsubs_total,
           " (", round(total_unsubs$unsubs_total/total_unsubs$n_condition*100, 5), "%)")
  )
)

# Display the table using pander
pander(unsubscribe_table,
       caption = "Counts and Percentages of Unsubscribes by Condition and Email Period (Within-Condition Percentages)")


```


### Primary Analyses (DV4): Unsubscribe Rate (Email 1 + Combined Emails)

```{r echo=FALSE, results="asis"}
# Models for Email 1 Period
model_unsub1 <- lm(unsub_email_1 ~ condition_model, data = master_data)
model_unsub1_controls <- lm(unsub_email_1 ~ condition_model + man + age, data = master_data)

# Models for Full Campaign
model_unsub_all <- lm(unsub_any ~ condition_model, data = master_data)
model_unsub_all_controls <- lm(unsub_any ~ condition_model + man + age, data = master_data)

# Calculate robust standard errors for all models
robust_se_unsub1 <- coeftest(model_unsub1, vcov = vcovHC(model_unsub1, type = "HC3"))[, "Std. Error"]
robust_se_unsub1_controls <- coeftest(model_unsub1_controls, vcov = vcovHC(model_unsub1_controls, type = "HC3"))[, "Std. Error"]
robust_se_unsub_all <- coeftest(model_unsub_all, vcov = vcovHC(model_unsub_all, type = "HC3"))[, "Std. Error"]
robust_se_unsub_all_controls <- coeftest(model_unsub_all_controls, vcov = vcovHC(model_unsub_all_controls, type = "HC3"))[, "Std. Error"]

# Wald tests for all models
wald_test1 <- linearHypothesis(model_unsub1,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_unsub1, type = "HC3"))
wald_test1_controls <- linearHypothesis(model_unsub1_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_unsub1_controls, type = "HC3"))
wald_test2 <- linearHypothesis(model_unsub_all,
                              "condition_modelProsocialExcuse = condition_modelExplicit",
                              vcov. = vcovHC(model_unsub_all, type = "HC3"))
wald_test2_controls <- linearHypothesis(model_unsub_all_controls,
                                      "condition_modelProsocialExcuse = condition_modelExplicit",
                                      vcov. = vcovHC(model_unsub_all_controls, type = "HC3"))

# Add the Controls? line for the stargazer table
controls_line <- list(
  c("Controls?", "No", "Yes", "No", "Yes")
)

# Use stargazer to output all model summaries
stargazer(model_unsub1, model_unsub1_controls, 
          model_unsub_all, model_unsub_all_controls,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_unsub1, robust_se_unsub1_controls,
                   robust_se_unsub_all, robust_se_unsub_all_controls),
          title = "OLS Model Results for Unsubscribe Rate",
          covariate.labels = c("Explicit", "Prosocial Excuse", "Man", "Age"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Unsubscribed (Email 1 Period)", "Unsubscribed (Full Campaign)"),
          star.char = c("***", "**", "*", "+"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE,
          add.lines = controls_line
          )

# Print Wald test results separately below the table
cat("\nWald Tests for Email 1 Period:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1$Df[2], wald_test1$Res.Df[2], 
            wald_test1$F[2], wald_test1$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test1_controls$Df[2], wald_test1_controls$Res.Df[2], 
            wald_test1_controls$F[2], wald_test1_controls$`Pr(>F)`[2]))

cat("\nWald Tests for Full Campaign:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2$Df[2], wald_test2$Res.Df[2], 
            wald_test2$F[2], wald_test2$`Pr(>F)`[2]))
cat("With Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test2_controls$Df[2], wald_test2_controls$Res.Df[2], 
            wald_test2_controls$F[2], wald_test2_controls$`Pr(>F)`[2]))
```

## Heterogeneous Treatment Effects

### Click Rate (DV1)

```{r echo=FALSE, results="asis"}
# Clean click data to create prior click indicator
clean_clicks <- click_raw %>%
  filter(!is.na(LinkName) & LinkName != "View in Browser") %>%
  mutate(
    Click_Date = as.POSIXct(`Click Date`)
  )

# Calculate the cutoff date for prior clicks (180 days before Email 1)
prior_cutoff_date <- email1_start - days(180)

# Create prior click indicator with lowercase 'id'
prior_clicks <- clean_clicks %>%
  filter(Click_Date < email1_start & Click_Date >= prior_cutoff_date) %>%
  distinct(ID) %>%
  rename(id = ID) %>%  # rename ID to id to match master_data
  mutate(prior_click = 1)

# Add prior_click to master_data
master_data <- master_data %>%
  left_join(prior_clicks, by = "id") %>%
  mutate(
    prior_click = replace_na(prior_click, 0),
    # Center age for interaction
    age_c = scale(age, center = TRUE, scale = FALSE)
  )

# Models for Email 1 Period
# 1. Gender interaction
model_gender_1 <- lm(clicked_email_1 ~ condition_model * man, data = master_data)
robust_se_gender_1 <- coeftest(model_gender_1, vcov = vcovHC(model_gender_1, type = "HC3"))[, "Std. Error"]

# 2. Age interaction
model_age_1 <- lm(clicked_email_1 ~ condition_model * age_c, data = master_data)
robust_se_age_1 <- coeftest(model_age_1, vcov = vcovHC(model_age_1, type = "HC3"))[, "Std. Error"]

# 3. Prior click interaction
model_prior_1 <- lm(clicked_email_1 ~ condition_model * prior_click, data = master_data)
robust_se_prior_1 <- coeftest(model_prior_1, vcov = vcovHC(model_prior_1, type = "HC3"))[, "Std. Error"]

# Models for Full Campaign
# 4. Gender interaction
model_gender_all <- lm(clicked_email_all ~ condition_model * man, data = master_data)
robust_se_gender_all <- coeftest(model_gender_all, vcov = vcovHC(model_gender_all, type = "HC3"))[, "Std. Error"]

# 5. Age interaction
model_age_all <- lm(clicked_email_all ~ condition_model * age_c, data = master_data)
robust_se_age_all <- coeftest(model_age_all, vcov = vcovHC(model_age_all, type = "HC3"))[, "Std. Error"]

# 6. Prior click interaction
model_prior_all <- lm(clicked_email_all ~ condition_model * prior_click, data = master_data)
robust_se_prior_all <- coeftest(model_prior_all, vcov = vcovHC(model_prior_all, type = "HC3"))[, "Std. Error"]

# Create labels for the models
model_labels <- c("Gender\n(Email 1)", "Age\n(Email 1)", "Prior Click\n(Email 1)",
                 "Gender\n(Full)", "Age\n(Full)", "Prior Click\n(Full)")

# Combined stargazer table
stargazer(model_gender_1, model_age_1, model_prior_1,
          model_gender_all, model_age_all, model_prior_all,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_gender_1, robust_se_age_1, robust_se_prior_1,
                   robust_se_gender_all, robust_se_age_all, robust_se_prior_all),
          title = "Heterogeneous Treatment Effects on Click-Through Rates",
          column.separate = 3,
          float.env = "table",
          font.size = "small",
          covariate.labels = c("Explicit", "Prosocial Excuse", "Man", 
                             "Prosocial Excuse × Man",
                             "Explicit × Man",
                             "Age (Centered)",
                             "Prosocial Excuse × Age",
                             "Explicit × Age",
                             "Prior Click",
                             "Prosocial Excuse × Prior Click",
                             "Explicit × Prior Click"),
          dep.var.caption = "Dependent Variable: Clicked",
          dep.var.labels = c("Email 1", "Full Campaign"),
          star.char = c("+", "*", "**", "***"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE
          )
```



```{r echo=FALSE, results="asis"}
# Add Wald tests for interaction terms
# Email 1 Period
# Gender interactions
wald_gender_1 <- linearHypothesis(model_gender_1,
                                 c("condition_modelProsocialExcuse:man = condition_modelExplicit:man"),
                                 vcov. = vcovHC(model_gender_1, type = "HC3"))

# Age interactions
wald_age_1 <- linearHypothesis(model_age_1,
                              c("condition_modelProsocialExcuse:age_c = condition_modelExplicit:age_c"),
                              vcov. = vcovHC(model_age_1, type = "HC3"))

# Prior click interactions
wald_prior_1 <- linearHypothesis(model_prior_1,
                                c("condition_modelProsocialExcuse:prior_click = condition_modelExplicit:prior_click"),
                                vcov. = vcovHC(model_prior_1, type = "HC3"))

# Full Campaign
# Gender interactions
wald_gender_all <- linearHypothesis(model_gender_all,
                                   c("condition_modelProsocialExcuse:man = condition_modelExplicit:man"),
                                   vcov. = vcovHC(model_gender_all, type = "HC3"))

# Age interactions
wald_age_all <- linearHypothesis(model_age_all,
                                c("condition_modelProsocialExcuse:age_c = condition_modelExplicit:age_c"),
                                vcov. = vcovHC(model_age_all, type = "HC3"))

# Prior click interactions
wald_prior_all <- linearHypothesis(model_prior_all,
                                  c("condition_modelProsocialExcuse:prior_click = condition_modelExplicit:prior_click"),
                                  vcov. = vcovHC(model_prior_all, type = "HC3"))

# Print Wald test results after the stargazer table
cat("\nWald Tests for Interaction Terms:\n")

cat("\nEmail 1 Period:\n")
cat("Gender Interactions:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_gender_1$Df[2], wald_gender_1$Res.Df[2], 
            wald_gender_1$F[2], wald_gender_1$`Pr(>F)`[2]))

cat("\nAge Interactions:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_age_1$Df[2], wald_age_1$Res.Df[2], 
            wald_age_1$F[2], wald_age_1$`Pr(>F)`[2]))

cat("\nPrior Click Interactions:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_prior_1$Df[2], wald_prior_1$Res.Df[2], 
            wald_prior_1$F[2], wald_prior_1$`Pr(>F)`[2]))

cat("\nFull Campaign:\n")
cat("Gender Interactions:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_gender_all$Df[2], wald_gender_all$Res.Df[2], 
            wald_gender_all$F[2], wald_gender_all$`Pr(>F)`[2]))

cat("\nAge Interactions:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_age_all$Df[2], wald_age_all$Res.Df[2], 
            wald_age_all$F[2], wald_age_all$`Pr(>F)`[2]))

cat("\nPrior Click Interactions:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_prior_all$Df[2], wald_prior_all$Res.Df[2], 
            wald_prior_all$F[2], wald_prior_all$`Pr(>F)`[2]))


```

\newpage

### Click Rate (intention-action gap)

```{r echo=FALSE, results="asis"}
# Get condition Ns
condition_totals <- master_data %>%
  group_by(condition) %>%
  summarize(n = n())

# Email 1 Period
email1_data <- master_data %>%
  group_by(condition) %>%
  summarize(
    n_condition = n(),
    n_clicked = sum(grepl("Honor Roll Touch 1", associated_email), na.rm = TRUE),
    n_donated = sum(donated_email_1, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    click_rate = n_clicked / n_condition * 100,
    donation_rate = n_donated / n_condition * 100,
    donation_given_click = (n_donated / n_clicked) * 100
  )

# Full Campaign
full_campaign_data <- master_data %>%
  group_by(condition) %>%
  summarize(
    n_condition = n(),
    n_clicked = sum(grepl("Honor Roll Touch", associated_email), na.rm = TRUE),
    n_donated = sum(donated_any, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    click_rate = n_clicked / n_condition * 100,
    donation_rate = n_donated / n_condition * 100,
    donation_given_click = (n_donated / n_clicked) * 100
  )

# Create Email 1 table
email1_table <- data.frame(
  Metric = c("Clicked N (%)", "Donated N (%)", "P(Donation | Click) (%)"),
  Control = c(
    paste0(email1_data$n_clicked[email1_data$condition == "Control"], 
           " (", round(email1_data$click_rate[email1_data$condition == "Control"], 3), "%)"),
    paste0(email1_data$n_donated[email1_data$condition == "Control"], 
           " (", round(email1_data$donation_rate[email1_data$condition == "Control"], 5), "%)"),
    paste0(round(email1_data$donation_given_click[email1_data$condition == "Control"], 2), "%")
  ),
  Explicit = c(
    paste0(email1_data$n_clicked[email1_data$condition == "Explicit"], 
           " (", round(email1_data$click_rate[email1_data$condition == "Explicit"], 3), "%)"),
    paste0(email1_data$n_donated[email1_data$condition == "Explicit"], 
           " (", round(email1_data$donation_rate[email1_data$condition == "Explicit"], 5), "%)"),
    paste0(round(email1_data$donation_given_click[email1_data$condition == "Explicit"], 2), "%")
  ),
  `Prosocial Excuse` = c(
    paste0(email1_data$n_clicked[email1_data$condition == "Prosocial Excuse"], 
           " (", round(email1_data$click_rate[email1_data$condition == "Prosocial Excuse"], 3), "%)"),
    paste0(email1_data$n_donated[email1_data$condition == "Prosocial Excuse"], 
           " (", round(email1_data$donation_rate[email1_data$condition == "Prosocial Excuse"], 5), "%)"),
    paste0(round(email1_data$donation_given_click[email1_data$condition == "Prosocial Excuse"], 2), "%")
  )
)

# Create Full Campaign table
full_campaign_table <- data.frame(
  Metric = c("Clicked N (%)", "Donated N (%)", "P(Donation | Click) (%)"),
  Control = c(
    paste0(full_campaign_data$n_clicked[full_campaign_data$condition == "Control"], 
           " (", round(full_campaign_data$click_rate[full_campaign_data$condition == "Control"], 3), "%)"),
    paste0(full_campaign_data$n_donated[full_campaign_data$condition == "Control"], 
           " (", round(full_campaign_data$donation_rate[full_campaign_data$condition == "Control"], 5), "%)"),
    paste0(round(full_campaign_data$donation_given_click[full_campaign_data$condition == "Control"], 2), "%")
  ),
  Explicit = c(
    paste0(full_campaign_data$n_clicked[full_campaign_data$condition == "Explicit"], 
           " (", round(full_campaign_data$click_rate[full_campaign_data$condition == "Explicit"], 3), "%)"),
    paste0(full_campaign_data$n_donated[full_campaign_data$condition == "Explicit"], 
           " (", round(full_campaign_data$donation_rate[full_campaign_data$condition == "Explicit"], 5), "%)"),
    paste0(round(full_campaign_data$donation_given_click[full_campaign_data$condition == "Explicit"], 2), "%")
  ),
  `Prosocial Excuse` = c(
    paste0(full_campaign_data$n_clicked[full_campaign_data$condition == "Prosocial Excuse"], 
           " (", round(full_campaign_data$click_rate[full_campaign_data$condition == "Prosocial Excuse"], 3), "%)"),
    paste0(full_campaign_data$n_donated[full_campaign_data$condition == "Prosocial Excuse"], 
           " (", round(full_campaign_data$donation_rate[full_campaign_data$condition == "Prosocial Excuse"], 5), "%)"),
    paste0(round(full_campaign_data$donation_given_click[full_campaign_data$condition == "Prosocial Excuse"], 2), "%")
  )
)

# Print tables with headers
cat("\nEmail 1 Period\n")
pander(email1_table,
       style = 'rmarkdown',
       split.table = Inf,
       justify = c('left', 'right', 'right', 'right'))

cat("\nFull Campaign\n")
pander(full_campaign_table,
       style = 'rmarkdown',
       split.table = Inf,
       justify = c('left', 'right', 'right', 'right'))


```

\newpage

### Analysis of P(Donation | Click)

```{r echo=FALSE, results="asis"}
# For Email 1: Create dataset of only those who clicked
email1_clickers <- master_data %>%
  filter(grepl("Honor Roll Touch 1", associated_email)) %>%
  mutate(
    donated = ifelse(donated_email_1 == 1, 1, 0)
  )

# For Full Campaign: Create dataset of only those who clicked
full_campaign_clickers <- master_data %>%
  filter(grepl("Honor Roll Touch", associated_email)) %>%
  mutate(
    donated = ifelse(donated_any == 1, 1, 0)
  )

# Models for Email 1 Period
model_donation_rate1 <- lm(donated ~ condition_model, data = email1_clickers)
robust_se_rate1 <- coeftest(model_donation_rate1, vcov = vcovHC(model_donation_rate1, type = "HC3"))[, "Std. Error"]

# Wald test for Email 1
wald_test_rate1 <- linearHypothesis(model_donation_rate1,
                                  "condition_modelProsocialExcuse = condition_modelExplicit",
                                  vcov. = vcovHC(model_donation_rate1, type = "HC3"))

# Models for Full Campaign
model_donation_rate_all <- lm(donated ~ condition_model, data = full_campaign_clickers)
robust_se_rate_all <- coeftest(model_donation_rate_all, vcov = vcovHC(model_donation_rate_all, type = "HC3"))[, "Std. Error"]

# Wald test for Full Campaign
wald_test_rate_all <- linearHypothesis(model_donation_rate_all,
                                     "condition_modelProsocialExcuse = condition_modelExplicit",
                                     vcov. = vcovHC(model_donation_rate_all, type = "HC3"))


# Use stargazer to output the model summaries
stargazer(model_donation_rate1, model_donation_rate_all,
          type = "latex",
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_rate1, robust_se_rate_all),
          title = "OLS Model Results for P(Donation | Click)",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Donated (Email 1)", "Donated (Full Campaign)"),
          star.char = c("***", "**", "*", "+"),
          star.cutoffs = c(0.1, 0.05, 0.01, 0.001),
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE
          )

# Print Wald test results separately below the table
cat("\nWald Tests for Email 1 Period:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test_rate1$Df[2], wald_test_rate1$Res.Df[2], 
            wald_test_rate1$F[2], wald_test_rate1$`Pr(>F)`[2]))

cat("\nWald Tests for Full Campaign:\n")
cat("Without Controls:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n", 
            wald_test_rate_all$Df[2], wald_test_rate_all$Res.Df[2], 
            wald_test_rate_all$F[2], wald_test_rate_all$`Pr(>F)`[2]))


```

\newpage

## Additional Analyses

### Distribution of Prior Clicks

```{r echo=FALSE, results="asis"}
# Calculate prior click distribution by condition
prior_click_dist <- master_data %>%
  group_by(condition) %>%
  summarize(
    n_total = n(),
    n_prior_clicks = sum(prior_click, na.rm = TRUE),
    prop_prior_clicks = mean(prior_click, na.rm = TRUE) * 100
  ) %>%
  mutate(
    `Prior Click N (%)` = paste0(n_prior_clicks, " (", round(prop_prior_clicks, 2), "%)")
  ) %>%
  select(condition, `Prior Click N (%)`)

# Add total row
total_prior_clicks <- master_data %>%
  summarize(
    n_total = n(),
    n_prior_clicks = sum(prior_click, na.rm = TRUE),
    prop_prior_clicks = mean(prior_click, na.rm = TRUE) * 100
  ) %>%
  mutate(
    condition = "Total",
    `Prior Click N (%)` = paste0(n_prior_clicks, " (", round(prop_prior_clicks, 2), "%)")
  ) %>%
  select(condition, `Prior Click N (%)`)

# Combine into a single table
prior_click_table <- bind_rows(prior_click_dist, total_prior_clicks) %>%
  rename(Condition = condition)

# Display the table using pander
pander(prior_click_table,
       caption = "Distribution of Prior Clicks by Condition",
       split.table = Inf)

# OLS model for prior click
model_prior_click <- lm(prior_click ~ condition_model, data = master_data)
robust_se_prior_click <- coeftest(model_prior_click, vcov = vcovHC(model_prior_click, type = "HC3"))[, "Std. Error"]

# Wald test for equivalence between Prosocial Excuse and Explicit conditions
wald_test_prior_click <- linearHypothesis(model_prior_click,
                                          "condition_modelProsocialExcuse = condition_modelExplicit",
                                          vcov. = vcovHC(model_prior_click, type = "HC3"))

# Display the model results
stargazer(model_prior_click,
          type = stargazer_type,
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_prior_click),
          title = "OLS Model for Prior Clicks by Condition",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = "Prior Click",
          notes = "+ p<0.1; * p<0.05; ** p<0.01; *** p<0.001",
          notes.append = FALSE
          )

# Print Wald test results
cat("\nWald Test for Prior Clicks:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_prior_click$Df[2], wald_test_prior_click$Res.Df[2],
            wald_test_prior_click$F[2], wald_test_prior_click$`Pr(>F)`[2]))
```

\newpage

### Donation Incidence (DV2) Among Email Openers

```{r echo=FALSE, results="asis"}
# Analyze donation behavior among participants who opened emails

# Subset data for participants who opened Email 1
email1_openers <- master_data %>%
  filter(opened_email_1 == 1)

# Subset data for participants who opened any email
email_all_openers <- master_data %>%
  filter(opened_email_all == 1)

# Summary tables for Email 1 openers
email1_openers_summary <- email1_openers %>%
  group_by(condition) %>%
  summarize(
    n_openers = n(),
    n_donated = sum(donated_email_1, na.rm = TRUE),
    donation_rate = mean(donated_email_1, na.rm = TRUE) * 100,
    total_amount = sum(amount_email_1, na.rm = TRUE)
  ) %>%
  mutate(
    `Donated N (%)` = paste0(n_donated, " (", round(donation_rate, 3), "%)"),
    `Total Amount` = paste0("$", format(round(total_amount, 3), big.mark = ","))
  ) %>%
  select(condition, n_openers, `Donated N (%)`, `Total Amount`)

# Summary tables for all email openers
email_all_openers_summary <- email_all_openers %>%
  group_by(condition) %>%
  summarize(
    n_openers = n(),
    n_donated = sum(donated_any, na.rm = TRUE),
    donation_rate = mean(donated_any, na.rm = TRUE) * 100,
    total_amount = sum(amount_any, na.rm = TRUE)
  ) %>%
  mutate(
    `Donated N (%)` = paste0(n_donated, " (", round(donation_rate, 3), "%)"),
    `Total Amount` = paste0("$", format(round(total_amount, 3), big.mark = ","))
  ) %>%
  select(condition, n_openers, `Donated N (%)`, `Total Amount`)

# Display tables
cat("\n**Donations Among Email 1 Openers**\n")
pander(email1_openers_summary,
       caption = "Donation Behavior Among Email 1 Openers",
       split.table = Inf)

cat("\n**Donations Among All Email Openers**\n")
pander(email_all_openers_summary,
       caption = "Donation Behavior Among All Email Openers",
       split.table = Inf)

# OLS models for donation incidence among Email 1 openers
model_donate_email1_openers <- lm(donated_email_1 ~ condition_model, data = email1_openers)
robust_se_donate_email1_openers <- coeftest(model_donate_email1_openers, vcov = vcovHC(model_donate_email1_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_donate_email1_openers <- linearHypothesis(model_donate_email1_openers,
                                                    "condition_modelProsocialExcuse = condition_modelExplicit",
                                                    vcov. = vcovHC(model_donate_email1_openers, type = "HC3"))

# OLS models for donation incidence among all email openers
model_donate_email_all_openers <- lm(donated_any ~ condition_model, data = email_all_openers)
robust_se_donate_email_all_openers <- coeftest(model_donate_email_all_openers, vcov = vcovHC(model_donate_email_all_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_donate_email_all_openers <- linearHypothesis(model_donate_email_all_openers,
                                                       "condition_modelProsocialExcuse = condition_modelExplicit",
                                                       vcov. = vcovHC(model_donate_email_all_openers, type = "HC3"))

# Display the model results
stargazer(model_donate_email1_openers, model_donate_email_all_openers,
          type = stargazer_type,
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_donate_email1_openers, robust_se_donate_email_all_openers),
          title = "OLS Models for Donation Incidence Among Email Openers",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Donated (Email 1 Openers)", "Donated (All Email Openers)"),
          notes = "+p<0.1; *p<0.05; **p<0.01; ***p<0.001",
          notes.append = FALSE
          )

# Print Wald test results
cat("\nWald Tests for Donation Incidence Among Email Openers:\n")
cat("Email 1 Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_donate_email1_openers$Df[2], wald_test_donate_email1_openers$Res.Df[2],
            wald_test_donate_email1_openers$F[2], wald_test_donate_email1_openers$`Pr(>F)`[2]))
cat("\nAll Email Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_donate_email_all_openers$Df[2], wald_test_donate_email_all_openers$Res.Df[2],
            wald_test_donate_email_all_openers$F[2], wald_test_donate_email_all_openers$`Pr(>F)`[2]))
```

\newpage

### Donation Amount (DV3) Among Email Openers

```{r echo=FALSE, results="asis"}
# This section analyzes donation amounts (DV3) among participants who opened emails.
# We analyze the data in three ways: raw amounts, log-transformed amounts, and amounts with outliers removed.

# -------------------------------------------------------------
# Define the email openers datasets (already defined)
# email1_openers and email_all_openers
# -------------------------------------------------------------

## Calculate median and MAD for non-zero donations among email openers
non_zero_donations_openers <- email_all_openers %>%
  filter(gift_amount > 0)
median_amount_openers <- median(non_zero_donations_openers$gift_amount, na.rm = TRUE)
mad_amount_openers <- mad(non_zero_donations_openers$gift_amount, na.rm = TRUE)
outlier_cutoff_openers <- median_amount_openers + (2.5 * mad_amount_openers)

# -------------------------------------------------------------
# Create amount variables and their transformations for openers
# -------------------------------------------------------------

# For Email 1 Openers
email1_openers <- email1_openers %>%
  mutate(
    # Raw amount
    amount_email_1 = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date < email2_start, 
      gift_amount, 0
    ),
    # Log-transformed amount (adding 1 to handle zeros)
    log_amount_email_1 = log(amount_email_1 + 1),
    # Amount with outliers removed
    amount_email_1_no_outliers = ifelse(
      amount_email_1 > outlier_cutoff_openers, NA, amount_email_1
    )
  )

# For All Email Openers
email_all_openers <- email_all_openers %>%
  mutate(
    # Raw amount
    amount_any = ifelse(
      made_gift == 1 & !is.na(gift_date) & 
        gift_date >= email1_start & 
        gift_date <= campaign_end,
      gift_amount, 0
    ),
    # Log-transformed amount (adding 1 to handle zeros)
    log_amount_any = log(amount_any + 1),
    # Amount with outliers removed
    amount_any_no_outliers = ifelse(
      amount_any > outlier_cutoff_openers, NA, amount_any
    )
  )

# -------------------------------------------------------------
# OLS Models for Donation Amounts (Raw)
# -------------------------------------------------------------

# Models for Email 1 Openers
model_amount_raw_email1_openers <- lm(amount_email_1 ~ condition_model, data = email1_openers)
robust_se_amount_raw_email1_openers <- coeftest(model_amount_raw_email1_openers, vcov = vcovHC(model_amount_raw_email1_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_amount_raw_email1_openers <- linearHypothesis(model_amount_raw_email1_openers,
                                                        "condition_modelProsocialExcuse = condition_modelExplicit",
                                                        vcov. = vcovHC(model_amount_raw_email1_openers, type = "HC3"))

# Models for All Email Openers
model_amount_raw_email_all_openers <- lm(amount_any ~ condition_model, data = email_all_openers)
robust_se_amount_raw_email_all_openers <- coeftest(model_amount_raw_email_all_openers, vcov = vcovHC(model_amount_raw_email_all_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_amount_raw_email_all_openers <- linearHypothesis(model_amount_raw_email_all_openers,
                                                           "condition_modelProsocialExcuse = condition_modelExplicit",
                                                           vcov. = vcovHC(model_amount_raw_email_all_openers, type = "HC3"))

# Display the model results
stargazer(model_amount_raw_email1_openers, model_amount_raw_email_all_openers,
          type = stargazer_type,
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_amount_raw_email1_openers, robust_se_amount_raw_email_all_openers),
          title = "OLS Models for Donation Amount (Raw) Among Email Openers",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Amount (Email 1 Openers)", "Amount (All Email Openers)"),
          notes = "+p<0.1; *p<0.05; **p<0.01; ***p<0.001",
          notes.append = FALSE
          )

# Print Wald test results
cat("\nWald Tests for Donation Amount (Raw) Among Email Openers:\n")
cat("Email 1 Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_amount_raw_email1_openers$Df[2], wald_test_amount_raw_email1_openers$Res.Df[2],
            wald_test_amount_raw_email1_openers$F[2], wald_test_amount_raw_email1_openers$`Pr(>F)`[2]))
cat("\nAll Email Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_amount_raw_email_all_openers$Df[2], wald_test_amount_raw_email_all_openers$Res.Df[2],
            wald_test_amount_raw_email_all_openers$F[2], wald_test_amount_raw_email_all_openers$`Pr(>F)`[2]))

# -------------------------------------------------------------
# OLS Models for Donation Amounts (Log-Transformed)
# -------------------------------------------------------------

# Models for Email 1 Openers
model_amount_log_email1_openers <- lm(log_amount_email_1 ~ condition_model, data = email1_openers)
robust_se_amount_log_email1_openers <- coeftest(model_amount_log_email1_openers, vcov = vcovHC(model_amount_log_email1_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_amount_log_email1_openers <- linearHypothesis(model_amount_log_email1_openers,
                                                        "condition_modelProsocialExcuse = condition_modelExplicit",
                                                        vcov. = vcovHC(model_amount_log_email1_openers, type = "HC3"))

# Models for All Email Openers
model_amount_log_email_all_openers <- lm(log_amount_any ~ condition_model, data = email_all_openers)
robust_se_amount_log_email_all_openers <- coeftest(model_amount_log_email_all_openers, vcov = vcovHC(model_amount_log_email_all_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_amount_log_email_all_openers <- linearHypothesis(model_amount_log_email_all_openers,
                                                           "condition_modelProsocialExcuse = condition_modelExplicit",
                                                           vcov. = vcovHC(model_amount_log_email_all_openers, type = "HC3"))

# Display the model results
stargazer(model_amount_log_email1_openers, model_amount_log_email_all_openers,
          type = stargazer_type,
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_amount_log_email1_openers, robust_se_amount_log_email_all_openers),
          title = "OLS Models for Donation Amount (Log-Transformed) Among Email Openers",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Log Amount (Email 1 Openers)", "Log Amount (All Email Openers)"),
          notes = "+p<0.1; *p<0.05; **p<0.01; ***p<0.001",
          notes.append = FALSE
          )

# Print Wald test results
cat("\nWald Tests for Donation Amount (Log-Transformed) Among Email Openers:\n")
cat("Email 1 Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_amount_log_email1_openers$Df[2], wald_test_amount_log_email1_openers$Res.Df[2],
            wald_test_amount_log_email1_openers$F[2], wald_test_amount_log_email1_openers$`Pr(>F)`[2]))
cat("\nAll Email Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_amount_log_email_all_openers$Df[2], wald_test_amount_log_email_all_openers$Res.Df[2],
            wald_test_amount_log_email_all_openers$F[2], wald_test_amount_log_email_all_openers$`Pr(>F)`[2]))

# -------------------------------------------------------------
# OLS Models for Donation Amounts (Outliers Removed)
# -------------------------------------------------------------

# Models for Email 1 Openers
model_amount_no_outliers_email1_openers <- lm(amount_email_1_no_outliers ~ condition_model, data = email1_openers)
robust_se_amount_no_outliers_email1_openers <- coeftest(model_amount_no_outliers_email1_openers, vcov = vcovHC(model_amount_no_outliers_email1_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_amount_no_outliers_email1_openers <- linearHypothesis(model_amount_no_outliers_email1_openers,
                                                                "condition_modelProsocialExcuse = condition_modelExplicit",
                                                                vcov. = vcovHC(model_amount_no_outliers_email1_openers, type = "HC3"))

# Models for All Email Openers
model_amount_no_outliers_email_all_openers <- lm(amount_any_no_outliers ~ condition_model, data = email_all_openers)
robust_se_amount_no_outliers_email_all_openers <- coeftest(model_amount_no_outliers_email_all_openers, vcov = vcovHC(model_amount_no_outliers_email_all_openers, type = "HC3"))[, "Std. Error"]

# Wald test
wald_test_amount_no_outliers_email_all_openers <- linearHypothesis(model_amount_no_outliers_email_all_openers,
                                                                   "condition_modelProsocialExcuse = condition_modelExplicit",
                                                                   vcov. = vcovHC(model_amount_no_outliers_email_all_openers, type = "HC3"))

# Display the model results
stargazer(model_amount_no_outliers_email1_openers, model_amount_no_outliers_email_all_openers,
          type = stargazer_type,
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_amount_no_outliers_email1_openers, robust_se_amount_no_outliers_email_all_openers),
          title = "OLS Models for Donation Amount (Outliers Removed) Among Email Openers",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Amount (Email 1 Openers)", "Amount (All Email Openers)"),
          notes = "+p<0.1; *p<0.05; **p<0.01; ***p<0.001",
          notes.append = FALSE
          )

# Print Wald test results
cat("\nWald Tests for Donation Amount (Outliers Removed) Among Email Openers:\n")
cat("Email 1 Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_amount_no_outliers_email1_openers$Df[2], wald_test_amount_no_outliers_email1_openers$Res.Df[2],
            wald_test_amount_no_outliers_email1_openers$F[2], wald_test_amount_no_outliers_email1_openers$`Pr(>F)`[2]))
cat("\nAll Email Openers:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_amount_no_outliers_email_all_openers$Df[2], wald_test_amount_no_outliers_email_all_openers$Res.Df[2],
            wald_test_amount_no_outliers_email_all_openers$F[2], wald_test_amount_no_outliers_email_all_openers$`Pr(>F)`[2]))
```

\newpage

### Baseline Balance Checks

```{r echo=FALSE, results="asis"}
# Check for balance in baseline variables across conditions
# For full sample
balance_full <- master_data %>%
  group_by(condition) %>%
  summarize(
    N = n(),
    Age_Mean = mean(age, na.rm = TRUE),
    Age_SD = sd(age, na.rm = TRUE),
    Male_Percentage = mean(man, na.rm = TRUE) * 100,
    Prior_Click_Percentage = mean(prior_click, na.rm = TRUE) * 100
  )

# Display the balance table
pander(balance_full,
       caption = "Baseline Variables by Condition (Full Sample)",
       split.table = Inf)

# OLS models to test for baseline differences in full sample
model_age_full <- lm(age ~ condition_model, data = master_data)
robust_se_age_full <- coeftest(model_age_full, vcov = vcovHC(model_age_full, type = "HC3"))[, "Std. Error"]

model_man_full <- lm(man ~ condition_model, data = master_data)
robust_se_man_full <- coeftest(model_man_full, vcov = vcovHC(model_man_full, type = "HC3"))[, "Std. Error"]

model_prior_click_full <- lm(prior_click ~ condition_model, data = master_data)
robust_se_prior_click_full <- coeftest(model_prior_click_full, vcov = vcovHC(model_prior_click_full, type = "HC3"))[, "Std. Error"]

# Wald tests for differences between Prosocial Excuse and Explicit conditions
wald_test_age_full <- linearHypothesis(model_age_full,
                                       "condition_modelProsocialExcuse = condition_modelExplicit",
                                       vcov. = vcovHC(model_age_full, type = "HC3"))

wald_test_man_full <- linearHypothesis(model_man_full,
                                       "condition_modelProsocialExcuse = condition_modelExplicit",
                                       vcov. = vcovHC(model_man_full, type = "HC3"))

wald_test_prior_click_full <- linearHypothesis(model_prior_click_full,
                                               "condition_modelProsocialExcuse = condition_modelExplicit",
                                               vcov. = vcovHC(model_prior_click_full, type = "HC3"))

# Display the model results
stargazer(model_age_full, model_man_full, model_prior_click_full,
          type = stargazer_type,
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_age_full, robust_se_man_full, robust_se_prior_click_full),
          title = "Baseline Balance Checks (Full Sample)",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Age", "Man", "Prior Click"),
          notes = "+p<0.1; *p<0.05; **p<0.01; ***p<0.001",
          notes.append = FALSE
          )

# Print Wald test results
cat("\nWald Tests for Baseline Differences (Full Sample):\n")
cat("Age:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_age_full$Df[2], wald_test_age_full$Res.Df[2],
            wald_test_age_full$F[2], wald_test_age_full$`Pr(>F)`[2]))
cat("\nMan:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_man_full$Df[2], wald_test_man_full$Res.Df[2],
            wald_test_man_full$F[2], wald_test_man_full$`Pr(>F)`[2]))
cat("\nPrior Click:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_prior_click_full$Df[2], wald_test_prior_click_full$Res.Df[2],
            wald_test_prior_click_full$F[2], wald_test_prior_click_full$`Pr(>F)`[2]))
```


\newpage

```{r echo=FALSE, results="asis"}
# For email openers
balance_openers <- email_all_openers %>%
  group_by(condition) %>%
  summarize(
    N = n(),
    Age_Mean = mean(age, na.rm = TRUE),
    Age_SD = sd(age, na.rm = TRUE),
    Male_Percentage = mean(man, na.rm = TRUE) * 100,
    Prior_Click_Percentage = mean(prior_click, na.rm = TRUE) * 100
  )

# Display the balance table
pander(balance_openers,
       caption = "Baseline Variables by Condition (Email Openers)",
       split.table = Inf)

# OLS models to test for baseline differences among openers
model_age_openers <- lm(age ~ condition_model, data = email_all_openers)
robust_se_age_openers <- coeftest(model_age_openers, vcov = vcovHC(model_age_openers, type = "HC3"))[, "Std. Error"]

model_man_openers <- lm(man ~ condition_model, data = email_all_openers)
robust_se_man_openers <- coeftest(model_man_openers, vcov = vcovHC(model_man_openers, type = "HC3"))[, "Std. Error"]

model_prior_click_openers <- lm(prior_click ~ condition_model, data = email_all_openers)
robust_se_prior_click_openers <- coeftest(model_prior_click_openers, vcov = vcovHC(model_prior_click_openers, type = "HC3"))[, "Std. Error"]

# Wald tests for differences between Prosocial Excuse and Explicit conditions
wald_test_age_openers <- linearHypothesis(model_age_openers,
                                          "condition_modelProsocialExcuse = condition_modelExplicit",
                                          vcov. = vcovHC(model_age_openers, type = "HC3"))

wald_test_man_openers <- linearHypothesis(model_man_openers,
                                          "condition_modelProsocialExcuse = condition_modelExplicit",
                                          vcov. = vcovHC(model_man_openers, type = "HC3"))

wald_test_prior_click_openers <- linearHypothesis(model_prior_click_openers,
                                                  "condition_modelProsocialExcuse = condition_modelExplicit",
                                                  vcov. = vcovHC(model_prior_click_openers, type = "HC3"))

# Display the model results
stargazer(model_age_openers, model_man_openers, model_prior_click_openers,
          type = stargazer_type,
          header = FALSE,
          style = "default",
          omit.stat = c("f", "ser", "adj.rsq"),
          report = "vc*s",
          se = list(robust_se_age_openers, robust_se_man_openers, robust_se_prior_click_openers),
          title = "Baseline Balance Checks (Email Openers)",
          covariate.labels = c("Explicit", "Prosocial Excuse"),
          dep.var.caption = "Dependent Variable:",
          dep.var.labels = c("Age", "Man", "Prior Click"),
          notes = "+p<0.1; *p<0.05; **p<0.01; ***p<0.001",
          notes.append = FALSE
          )

# Print Wald test results
cat("\nWald Tests for Baseline Differences (Email Openers):\n")
cat("Age:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_age_openers$Df[2], wald_test_age_openers$Res.Df[2],
            wald_test_age_openers$F[2], wald_test_age_openers$`Pr(>F)`[2]))
cat("\nMan:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_man_openers$Df[2], wald_test_man_openers$Res.Df[2],
            wald_test_man_openers$F[2], wald_test_man_openers$`Pr(>F)`[2]))
cat("\nPrior Click:\n")
cat(sprintf("F(%d, %.0f) = %.3f, p = %.3g\n",
            wald_test_prior_click_openers$Df[2], wald_test_prior_click_openers$Res.Df[2],
            wald_test_prior_click_openers$F[2], wald_test_prior_click_openers$`Pr(>F)`[2]))
```